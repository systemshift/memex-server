{% extends "base.html" %}

{% block title %}Memex Workspace{% endblock %}

{% block head %}
<style>
/* User selector and notification styles */
.user-selector {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    background: var(--surface-2);
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.2s;
}

.user-selector:hover {
    background: var(--surface-3);
}

.user-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 14px;
}

.user-info {
    display: flex;
    flex-direction: column;
}

.user-name {
    font-weight: 500;
    font-size: 14px;
}

.user-role {
    font-size: 11px;
    color: var(--text-muted);
    text-transform: capitalize;
}

.user-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: 8px;
    background: var(--surface-1);
    border: 1px solid var(--border);
    border-radius: 8px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    min-width: 200px;
    z-index: 100;
    display: none;
}

.user-dropdown.open {
    display: block;
}

.user-option {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    cursor: pointer;
    transition: background 0.2s;
}

.user-option:hover {
    background: var(--surface-2);
}

.user-option:first-child {
    border-radius: 8px 8px 0 0;
}

.user-option:last-child {
    border-radius: 0 0 8px 8px;
}

.user-option.active {
    background: var(--primary-alpha);
}

/* Notification bell */
.notification-bell {
    position: relative;
    padding: 8px;
    background: transparent;
    border: none;
    cursor: pointer;
    color: var(--text);
    border-radius: 8px;
    transition: background 0.2s;
}

.notification-bell:hover {
    background: var(--surface-2);
}

.notification-badge {
    position: absolute;
    top: 4px;
    right: 4px;
    background: #ef4444;
    color: white;
    font-size: 10px;
    font-weight: 600;
    min-width: 16px;
    height: 16px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 4px;
}

.notification-badge.hidden {
    display: none;
}

/* Notification panel */
.notification-panel {
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: 8px;
    background: var(--surface-1);
    border: 1px solid var(--border);
    border-radius: 12px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.15);
    width: 360px;
    max-height: 480px;
    z-index: 100;
    display: none;
    overflow: hidden;
}

.notification-panel.open {
    display: block;
}

.notification-header {
    padding: 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.notification-header h4 {
    margin: 0;
    font-size: 14px;
    font-weight: 600;
}

.mark-all-read {
    font-size: 12px;
    color: var(--primary);
    cursor: pointer;
    background: none;
    border: none;
}

.notification-list {
    max-height: 400px;
    overflow-y: auto;
}

.notification-item {
    padding: 16px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: background 0.2s;
}

.notification-item:hover {
    background: var(--surface-2);
}

.notification-item.unread {
    background: var(--primary-alpha);
}

.notification-item.unread:hover {
    background: var(--surface-2);
}

.notification-type {
    display: inline-block;
    padding: 2px 8px;
    background: var(--primary);
    color: white;
    font-size: 10px;
    font-weight: 600;
    border-radius: 4px;
    margin-bottom: 8px;
    text-transform: uppercase;
}

.notification-title {
    font-weight: 500;
    margin-bottom: 4px;
}

.notification-message {
    font-size: 13px;
    color: var(--text-muted);
    margin-bottom: 4px;
}

.notification-time {
    font-size: 11px;
    color: var(--text-muted);
}

.notification-empty {
    padding: 32px 16px;
    text-align: center;
    color: var(--text-muted);
}

/* Handoff chain display */
.handoff-chain {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 16px;
    background: var(--surface-2);
    border-radius: 8px;
    margin-bottom: 16px;
    overflow-x: auto;
}

.chain-step {
    display: flex;
    align-items: center;
    gap: 8px;
}

.chain-user {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.chain-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 14px;
}

.chain-name {
    font-size: 11px;
    margin-top: 4px;
}

.chain-arrow {
    color: var(--text-muted);
}

/* Handoff form in generated content */
.handoff-form-container {
    margin-top: 24px;
    padding-top: 24px;
    border-top: 1px solid var(--border);
}

.handoff-form-container h4 {
    margin: 0 0 16px 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.handoff-targets {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.handoff-target {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: var(--surface-2);
    border: 2px solid transparent;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
}

.handoff-target:hover {
    background: var(--surface-3);
    border-color: var(--primary);
}

.handoff-target.selected {
    border-color: var(--primary);
    background: var(--primary-alpha);
}

.handoff-target-info {
    display: flex;
    flex-direction: column;
}

.handoff-target-name {
    font-weight: 500;
}

.handoff-target-role {
    font-size: 12px;
    color: var(--text-muted);
}

.handoff-message {
    margin-top: 16px;
}

.handoff-message textarea {
    width: 100%;
    min-height: 80px;
    padding: 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--surface-1);
    color: var(--text);
    font-family: inherit;
    resize: vertical;
}

.handoff-submit {
    margin-top: 16px;
    display: flex;
    gap: 12px;
}

/* Work item context card */
.work-item-context {
    background: var(--surface-2);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
}

.work-item-context h4 {
    margin: 0 0 8px 0;
    font-size: 14px;
}

.work-item-meta {
    display: flex;
    gap: 16px;
    font-size: 13px;
    color: var(--text-muted);
}

/* Role-specific colors */
.role-sales { --role-color: #10b981; }
.role-cs { --role-color: #6366f1; }
.role-engineering { --role-color: #f59e0b; }
.role-manager { --role-color: #8b5cf6; }

.user-avatar.sales { background: #10b981; }
.user-avatar.cs { background: #6366f1; }
.user-avatar.engineering { background: #f59e0b; }
.user-avatar.manager { background: #8b5cf6; }

/* Dashboard link */
.dashboard-link {
    padding: 8px 16px;
    background: var(--surface-2);
    border-radius: 8px;
    color: var(--text);
    text-decoration: none;
    font-size: 13px;
    font-weight: 500;
    transition: background 0.2s;
}

.dashboard-link:hover {
    background: var(--surface-3);
}
</style>
{% endblock %}

{% block body %}
<div class="workspace">
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <span class="logo-icon">M</span>
            <span class="logo-text">Workspace</span>
        </div>
        <div class="header-actions">
            <!-- Dashboard Link (for manager view) -->
            <a href="/dashboard" class="dashboard-link" id="dashboard-link" style="display: none;">
                Dashboard
            </a>

            <!-- Notification Bell -->
            <div style="position: relative;">
                <button class="notification-bell" id="notification-bell" title="Notifications">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                    </svg>
                    <span class="notification-badge hidden" id="notification-count">0</span>
                </button>

                <!-- Notification Panel -->
                <div class="notification-panel" id="notification-panel">
                    <div class="notification-header">
                        <h4>Notifications</h4>
                        <button class="mark-all-read" id="mark-all-read">Mark all read</button>
                    </div>
                    <div class="notification-list" id="notification-list">
                        <div class="notification-empty">No notifications</div>
                    </div>
                </div>
            </div>

            <!-- User Selector -->
            <div style="position: relative;">
                <div class="user-selector" id="user-selector">
                    <div class="user-avatar sales" id="current-avatar">A</div>
                    <div class="user-info">
                        <span class="user-name" id="current-user-name">Alex</span>
                        <span class="user-role" id="current-user-role">Sales</span>
                    </div>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="m6 9 6 6 6-6"/>
                    </svg>
                </div>

                <!-- User Dropdown -->
                <div class="user-dropdown" id="user-dropdown">
                    <div class="user-option active" data-user="alex">
                        <div class="user-avatar sales">A</div>
                        <div class="user-info">
                            <span class="user-name">Alex</span>
                            <span class="user-role">Sales Rep</span>
                        </div>
                    </div>
                    <div class="user-option" data-user="jordan">
                        <div class="user-avatar cs">J</div>
                        <div class="user-info">
                            <span class="user-name">Jordan</span>
                            <span class="user-role">Customer Success</span>
                        </div>
                    </div>
                    <div class="user-option" data-user="sam">
                        <div class="user-avatar engineering">S</div>
                        <div class="user-info">
                            <span class="user-name">Sam</span>
                            <span class="user-role">Solutions Engineer</span>
                        </div>
                    </div>
                    <div class="user-option" data-user="morgan">
                        <div class="user-avatar manager">M</div>
                        <div class="user-info">
                            <span class="user-name">Morgan</span>
                            <span class="user-role">VP Operations</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <!-- Input Area -->
        <div class="input-area">
            <div class="input-container">
                <input
                    type="text"
                    id="main-input"
                    class="main-input"
                    placeholder="Describe what you need..."
                    autofocus
                >
                <button id="submit-btn" class="submit-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 12h14M12 5l7 7-7 7"/>
                    </svg>
                </button>
            </div>
            <div class="quick-actions">
                <button class="quick-action" data-input="New deal closed with">Deal</button>
                <button class="quick-action" data-input="Forward to ">Handoff</button>
                <button class="quick-action" data-input="Show my pending work">My Work</button>
                <button class="quick-action" data-input="Customer needs help with">Support</button>
            </div>
        </div>

        <!-- Generated Content Area -->
        <div class="content-area" id="content-area">
            <div class="welcome" id="welcome">
                <h2>What do you need?</h2>
                <p>Describe your task in natural language. The interface will adapt based on your role.</p>

                <div class="examples">
                    <div class="example" data-input="Just closed deal with Acme Corp, $50k ARR, they need SSO. Forward to Jordan for onboarding.">
                        <div class="example-icon">$</div>
                        <div class="example-text">
                            <div class="example-title">Close a Deal</div>
                            <div class="example-desc">Record deal details and hand off to CS</div>
                        </div>
                    </div>
                    <div class="example" data-input="Customer onboarding complete for TechStart, they need API integration. Forward to Sam.">
                        <div class="example-icon">H</div>
                        <div class="example-text">
                            <div class="example-title">Hand Off Work</div>
                            <div class="example-desc">Transfer work to another team member</div>
                        </div>
                    </div>
                    <div class="example" data-input="What deals closed last week?">
                        <div class="example-icon">?</div>
                        <div class="example-text">
                            <div class="example-title">Ask Questions</div>
                            <div class="example-desc">Search organizational memory</div>
                        </div>
                    </div>
                    <div class="example" data-input="Show all my pending work items">
                        <div class="example-icon">T</div>
                        <div class="example-text">
                            <div class="example-title">View My Work</div>
                            <div class="example-desc">See tasks assigned to you</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Generated Form/Content goes here -->
            <div class="generated-content" id="generated-content" style="display: none;">
                <!-- Handoff chain (if applicable) -->
                <div class="handoff-chain" id="handoff-chain" style="display: none;"></div>

                <!-- Work item context -->
                <div class="work-item-context" id="work-item-context" style="display: none;"></div>

                <div class="content-header" id="content-header"></div>
                <form id="generated-form" class="generated-form">
                    <div id="form-fields"></div>
                </form>

                <!-- Handoff form -->
                <div class="handoff-form-container" id="handoff-form-container" style="display: none;">
                    <h4>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 12h14M12 5l7 7-7 7"/>
                        </svg>
                        Forward to Team Member
                    </h4>
                    <div class="handoff-targets" id="handoff-targets"></div>
                    <div class="handoff-message">
                        <textarea id="handoff-message" placeholder="Add a message for the recipient..."></textarea>
                    </div>
                    <div class="handoff-submit">
                        <button type="button" class="btn btn-primary" id="send-handoff">
                            Send Handoff
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div class="loading" id="loading" style="display: none;">
                <div class="loading-spinner"></div>
                <div class="loading-text">Generating interface...</div>
            </div>
        </div>
    </main>

    <!-- Status Bar -->
    <footer class="status-bar">
        <div class="status-item">
            <span class="status-dot online"></span>
            <span>Connected to Memex</span>
        </div>
        <div class="status-item" id="role-indicator"></div>
        <div class="status-item" id="session-info"></div>
    </footer>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/notifications.js') }}"></script>
<script>
// Initialize workspace with multi-user support
document.addEventListener('DOMContentLoaded', function() {
    initWorkspace();
    initMultiUser();
});
</script>
{% endblock %}
