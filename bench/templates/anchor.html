<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anchor - Neo Language Skills</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --bg: #0a0a0a;
            --bg-secondary: #111111;
            --bg-tertiary: #1a1a1a;
            --text: #e0e0e0;
            --text-dim: #707070;
            --accent: #00ff88;
            --accent-dim: #00aa5a;
            --border: #222;
            --anchor-deadline: #ff6b6b;
            --anchor-owner: #4ecdc4;
            --anchor-gate: #ffe66d;
            --anchor-risk: #ff8c42;
            --anchor-claim: #a29bfe;
            --anchor-evidence: #74b9ff;
            --anchor-question: #fd79a8;
            --anchor-default: #00ff88;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        /* Header */
        header {
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            font-size: 1.2rem;
            color: var(--accent);
            text-decoration: none;
        }
        .logo span { color: var(--text-dim); }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .lens-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .lens-selector label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .lens-selector select {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 0.5rem 1rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            border-radius: 4px;
            cursor: pointer;
        }

        .stats-bar {
            display: flex;
            gap: 1.5rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
        }
        .stats-bar span { color: var(--accent); }

        /* Main container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 2rem;
        }

        .tab {
            padding: 1rem 2rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            color: var(--text-dim);
            background: none;
            border: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover { color: var(--text); }
        .tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* Write tab */
        .write-section textarea {
            width: 100%;
            min-height: 300px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 1.5rem;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1rem;
            line-height: 1.8;
            border-radius: 6px;
            resize: vertical;
        }

        .write-section textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .write-section textarea::placeholder {
            color: var(--text-dim);
        }

        .write-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
        }

        .extract-btn {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 0.75rem 2rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            font-weight: 500;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .extract-btn:hover { background: var(--accent-dim); color: #fff; }
        .extract-btn:disabled { background: var(--border); cursor: not-allowed; }

        .example-btns {
            display: flex;
            gap: 0.5rem;
        }

        .example-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-dim);
            padding: 0.5rem 0.75rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            border-radius: 4px;
            cursor: pointer;
        }
        .example-btn:hover { border-color: var(--accent); color: var(--accent); }

        /* Anchors chips */
        .anchors-section {
            margin-top: 2rem;
        }

        .section-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 1rem;
        }

        .anchors-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .anchor-chip {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .anchor-chip .type {
            color: var(--anchor-default);
            font-size: 0.7rem;
            text-transform: uppercase;
        }

        .anchor-chip.deadline .type { color: var(--anchor-deadline); }
        .anchor-chip.owner .type { color: var(--anchor-owner); }
        .anchor-chip.gate .type { color: var(--anchor-gate); }
        .anchor-chip.risk .type { color: var(--anchor-risk); }
        .anchor-chip.claim .type { color: var(--anchor-claim); }
        .anchor-chip.evidence .type { color: var(--anchor-evidence); }
        .anchor-chip.question .type { color: var(--anchor-question); }

        /* Prose tab */
        .prose-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 2rem;
            line-height: 2;
            font-size: 1.1rem;
        }

        .prose-section .anchor {
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .prose-section .anchor:hover {
            filter: brightness(1.2);
        }

        .prose-section .anchor-deadline { background: rgba(255, 107, 107, 0.3); border-bottom: 2px solid var(--anchor-deadline); }
        .prose-section .anchor-owner { background: rgba(78, 205, 196, 0.3); border-bottom: 2px solid var(--anchor-owner); }
        .prose-section .anchor-gate { background: rgba(255, 230, 109, 0.3); border-bottom: 2px solid var(--anchor-gate); }
        .prose-section .anchor-risk { background: rgba(255, 140, 66, 0.3); border-bottom: 2px solid var(--anchor-risk); }
        .prose-section .anchor-claim { background: rgba(162, 155, 254, 0.3); border-bottom: 2px solid var(--anchor-claim); }
        .prose-section .anchor-evidence { background: rgba(116, 185, 255, 0.3); border-bottom: 2px solid var(--anchor-evidence); }
        .prose-section .anchor-question { background: rgba(253, 121, 168, 0.3); border-bottom: 2px solid var(--anchor-question); }
        .prose-section .anchor-action-item { background: rgba(0, 255, 136, 0.3); border-bottom: 2px solid var(--accent); }
        .prose-section .anchor-decision { background: rgba(255, 255, 255, 0.2); border-bottom: 2px solid #fff; }
        .prose-section .anchor-agreement { background: rgba(0, 255, 136, 0.2); border-bottom: 2px solid var(--accent); }
        .prose-section .anchor-dependency { background: rgba(200, 200, 200, 0.2); border-bottom: 2px solid #888; }
        .prose-section .anchor-assumption { background: rgba(162, 155, 254, 0.2); border-bottom: 2px solid var(--anchor-claim); }
        .prose-section .anchor-finding { background: rgba(116, 185, 255, 0.2); border-bottom: 2px solid var(--anchor-evidence); }
        .prose-section .anchor-concern { background: rgba(255, 140, 66, 0.2); border-bottom: 2px solid var(--anchor-risk); }

        .prose-empty {
            color: var(--text-dim);
            text-align: center;
            padding: 3rem;
        }

        /* Anchor detail panel */
        .anchor-detail {
            display: none;
            margin-top: 1.5rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 1.5rem;
        }

        .anchor-detail.show { display: block; }

        .anchor-detail h3 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            color: var(--accent);
            margin-bottom: 1rem;
        }

        .anchor-detail .props {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
        }

        .anchor-detail .prop {
            margin-bottom: 0.5rem;
        }

        .anchor-detail .prop-key {
            color: var(--text-dim);
        }

        /* Graph tab */
        .graph-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            height: 500px;
            position: relative;
        }

        .graph-section svg {
            width: 100%;
            height: 100%;
        }

        .graph-empty {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-dim);
            text-align: center;
        }

        /* Graph styles */
        .node circle {
            stroke: var(--bg);
            stroke-width: 2px;
        }

        .node text {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            fill: var(--text);
        }

        .link {
            stroke: var(--border);
            stroke-opacity: 0.6;
        }

        .link-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 8px;
            fill: var(--text-dim);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-dim);
            font-family: 'JetBrains Mono', monospace;
        }

        /* Results stats */
        .result-stats {
            margin-top: 1.5rem;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: var(--text-dim);
            display: flex;
            gap: 2rem;
        }

        .result-stats span { color: var(--accent); }

        /* Legend */
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        @media (max-width: 768px) {
            .header-controls { flex-direction: column; gap: 0.5rem; }
            .stats-bar { display: none; }
            .tabs { overflow-x: auto; }
            .tab { padding: 0.75rem 1rem; font-size: 0.8rem; }
        }
    </style>
</head>
<body>
    <header>
        <a href="/" class="logo">anchor<span>.demo</span></a>
        <div class="header-controls">
            <div class="lens-selector">
                <label>Lens:</label>
                <select id="lens-select">
                    <option value="org-planning">Org Planning</option>
                    <option value="research">Research</option>
                    <option value="conversation">Conversation</option>
                </select>
            </div>
            <div class="stats-bar">
                <div><span id="stat-lenses">0</span> lenses</div>
                <div><span id="stat-anchors">0</span> anchors</div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="tabs">
            <button class="tab active" data-tab="write">Write</button>
            <button class="tab" data-tab="prose">Prose View</button>
            <button class="tab" data-tab="graph">Graph View</button>
        </div>

        <!-- Write Tab -->
        <div id="tab-write" class="tab-content active">
            <div class="write-section">
                <textarea id="content-input" placeholder="Paste or write your text here...

Example: Meeting notes, project plans, research notes, conversation transcripts.

The lens will extract structured anchors (commitments, deadlines, questions, etc.) that you can then view and explore."></textarea>
                <div class="write-actions">
                    <div class="example-btns">
                        <button class="example-btn" onclick="loadExample('planning')">Planning example</button>
                        <button class="example-btn" onclick="loadExample('research')">Research example</button>
                        <button class="example-btn" onclick="loadExample('meeting')">Meeting example</button>
                    </div>
                    <button class="extract-btn" id="extract-btn" onclick="extractAnchors()">Extract Anchors</button>
                </div>
            </div>

            <div class="anchors-section" id="anchors-section" style="display: none;">
                <div class="section-label">Extracted Anchors</div>
                <div class="anchors-list" id="anchors-list"></div>
                <div class="result-stats" id="result-stats"></div>
            </div>
        </div>

        <!-- Prose Tab -->
        <div id="tab-prose" class="tab-content">
            <div class="legend" id="prose-legend"></div>
            <div class="prose-section" id="prose-content">
                <div class="prose-empty">Extract anchors from the Write tab to see annotated prose here.</div>
            </div>
            <div class="anchor-detail" id="anchor-detail">
                <h3 id="detail-title">Anchor Details</h3>
                <div class="props" id="detail-props"></div>
            </div>
        </div>

        <!-- Graph Tab -->
        <div id="tab-graph" class="tab-content">
            <div class="legend">
                <div class="legend-item"><div class="legend-dot" style="background: var(--accent)"></div> Lens</div>
                <div class="legend-item"><div class="legend-dot" style="background: var(--anchor-deadline)"></div> Deadline</div>
                <div class="legend-item"><div class="legend-dot" style="background: var(--anchor-owner)"></div> Owner</div>
                <div class="legend-item"><div class="legend-dot" style="background: var(--anchor-gate)"></div> Gate</div>
                <div class="legend-item"><div class="legend-dot" style="background: var(--anchor-claim)"></div> Claim</div>
            </div>
            <div class="graph-section" id="graph-container">
                <div class="graph-empty">Extract anchors to see the knowledge graph.</div>
            </div>
        </div>
    </div>

    <script>
        // State
        let currentAnchors = [];
        let currentLensId = 'org-planning';
        let annotatedHtml = '';

        // Examples
        const examples = {
            planning: `Ship beta by Jan 14. Omar owns the release.

Blocked on API review - Sara needs to approve the schema changes before we can proceed.

Risk: If the cloud migration slips, we might miss the Feb launch window.

Dependencies:
- Frontend needs backend API (due Jan 10)
- QA testing requires staging env (blocked on DevOps)`,

            research: `Claim: Large language models show emergent reasoning capabilities at scale.

Evidence: GPT-4 achieves 86% on the MMLU benchmark, up from 43% for GPT-3.

Question: Does chain-of-thought prompting improve performance on novel tasks?

Assumption: We assume the benchmark datasets are representative of real-world reasoning.

Finding: Fine-tuning on code improves mathematical reasoning by 15%.`,

            meeting: `Action item: Sarah will draft the Q1 roadmap by Friday.

Decision: We agreed to postpone the mobile app launch to Q2.

Question: What's our budget for contractor support?
Answer: $50k approved for Q1.

Concern: The team is stretched thin with the current timeline.

Agreement: Weekly standups will move to Tuesday 10am starting next week.`
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadLenses();
            loadStats();

            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });

            // Lens selector
            document.getElementById('lens-select').addEventListener('change', (e) => {
                currentLensId = e.target.value;
            });
        });

        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');

            if (tabId === 'graph' && currentAnchors.length > 0) {
                renderGraph();
            }
        }

        function loadExample(type) {
            document.getElementById('content-input').value = examples[type];
            // Switch lens based on example
            if (type === 'research') {
                document.getElementById('lens-select').value = 'research';
                currentLensId = 'research';
            } else if (type === 'meeting') {
                document.getElementById('lens-select').value = 'conversation';
                currentLensId = 'conversation';
            } else {
                document.getElementById('lens-select').value = 'org-planning';
                currentLensId = 'org-planning';
            }
        }

        async function loadLenses() {
            try {
                const resp = await fetch('/api/lenses');
                const data = await resp.json();
                // Update select options if needed
            } catch (e) {
                console.error('Failed to load lenses:', e);
            }
        }

        async function loadStats() {
            try {
                const resp = await fetch('/api/stats');
                const data = await resp.json();
                document.getElementById('stat-lenses').textContent = data.lenses || 0;
                document.getElementById('stat-anchors').textContent = data.anchors || 0;
            } catch (e) {
                console.error('Failed to load stats:', e);
            }
        }

        async function extractAnchors() {
            const content = document.getElementById('content-input').value;
            if (!content.trim()) {
                alert('Please enter some text to analyze.');
                return;
            }

            const btn = document.getElementById('extract-btn');
            btn.disabled = true;
            btn.textContent = 'Extracting...';

            try {
                const resp = await fetch('/api/extract', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        content: content,
                        lens_id: currentLensId,
                        store: true
                    })
                });

                const data = await resp.json();

                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }

                currentAnchors = data.anchors || [];
                annotatedHtml = data.annotated_html || '';

                // Update anchors list
                renderAnchorsList();

                // Update prose view
                renderProseView();

                // Show stats
                document.getElementById('result-stats').innerHTML = `
                    <div><span>${currentAnchors.length}</span> anchors extracted</div>
                    <div><span>${data.time}s</span> processing time</div>
                    <div>Lens: <span>${currentLensId}</span></div>
                `;

                // Refresh global stats
                loadStats();

            } catch (e) {
                alert('Error: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Extract Anchors';
            }
        }

        function renderAnchorsList() {
            const container = document.getElementById('anchors-list');
            const section = document.getElementById('anchors-section');

            if (currentAnchors.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            container.innerHTML = currentAnchors.map(a => `
                <div class="anchor-chip ${a.type.toLowerCase()}">
                    <span class="type">${a.type}</span>
                    <span>${a.text}</span>
                </div>
            `).join('');
        }

        function renderProseView() {
            const container = document.getElementById('prose-content');
            const legend = document.getElementById('prose-legend');

            if (!annotatedHtml || currentAnchors.length === 0) {
                container.innerHTML = '<div class="prose-empty">No anchors extracted yet.</div>';
                legend.innerHTML = '';
                return;
            }

            container.innerHTML = annotatedHtml;

            // Build legend from anchor types
            const types = [...new Set(currentAnchors.map(a => a.type.toLowerCase()))];
            legend.innerHTML = types.map(t => `
                <div class="legend-item">
                    <div class="legend-dot" style="background: var(--anchor-${t}, var(--anchor-default))"></div>
                    ${t}
                </div>
            `).join('');

            // Add click handlers to anchors
            container.querySelectorAll('.anchor').forEach(el => {
                el.addEventListener('click', () => showAnchorDetail(el.dataset.id));
            });
        }

        function showAnchorDetail(anchorId) {
            const anchor = currentAnchors.find(a => a.id === anchorId);
            if (!anchor) return;

            const detail = document.getElementById('anchor-detail');
            const title = document.getElementById('detail-title');
            const props = document.getElementById('detail-props');

            title.textContent = `${anchor.type}: ${anchor.id}`;

            let propsHtml = `
                <div class="prop"><span class="prop-key">text:</span> "${anchor.text}"</div>
            `;

            if (anchor.properties) {
                for (const [key, value] of Object.entries(anchor.properties)) {
                    propsHtml += `<div class="prop"><span class="prop-key">${key}:</span> ${value}</div>`;
                }
            }

            if (anchor.matched_patterns && anchor.matched_patterns.length > 0) {
                propsHtml += `<div class="prop"><span class="prop-key">patterns:</span> ${anchor.matched_patterns.join(', ')}</div>`;
            }

            props.innerHTML = propsHtml;
            detail.classList.add('show');
        }

        async function renderGraph() {
            const container = document.getElementById('graph-container');

            if (currentAnchors.length === 0) {
                container.innerHTML = '<div class="graph-empty">Extract anchors to see the knowledge graph.</div>';
                return;
            }

            try {
                const resp = await fetch(`/api/graph/${currentLensId}`);
                const data = await resp.json();

                if (!data.nodes || data.nodes.length === 0) {
                    container.innerHTML = '<div class="graph-empty">No graph data available.</div>';
                    return;
                }

                // Clear and render D3 graph
                container.innerHTML = '';
                renderD3Graph(container, data);

            } catch (e) {
                container.innerHTML = `<div class="graph-empty">Error loading graph: ${e.message}</div>`;
            }
        }

        function renderD3Graph(container, data) {
            const width = container.clientWidth;
            const height = container.clientHeight;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            const g = svg.append('g');

            // Zoom behavior
            svg.call(d3.zoom()
                .extent([[0, 0], [width, height]])
                .scaleExtent([0.5, 4])
                .on('zoom', (event) => g.attr('transform', event.transform)));

            // Color scale
            const colorScale = {
                'Lens': '#00ff88',
                'Deadline': '#ff6b6b',
                'Owner': '#4ecdc4',
                'Gate': '#ffe66d',
                'Risk': '#ff8c42',
                'Claim': '#a29bfe',
                'Evidence': '#74b9ff',
                'Question': '#fd79a8',
                'Action-Item': '#00ff88',
                'Decision': '#ffffff',
                'Agreement': '#00cc6a',
                'Dependency': '#888888',
                'default': '#666666'
            };

            const getColor = (node) => colorScale[node.type] || colorScale.default;

            // Force simulation
            const simulation = d3.forceSimulation(data.nodes)
                .force('link', d3.forceLink(data.edges).id(d => d.id).distance(100))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(40));

            // Links
            const link = g.append('g')
                .selectAll('line')
                .data(data.edges)
                .join('line')
                .attr('class', 'link')
                .attr('stroke-width', 1.5);

            // Link labels
            const linkLabel = g.append('g')
                .selectAll('text')
                .data(data.edges)
                .join('text')
                .attr('class', 'link-label')
                .text(d => d.type);

            // Nodes
            const node = g.append('g')
                .selectAll('g')
                .data(data.nodes)
                .join('g')
                .attr('class', 'node')
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));

            node.append('circle')
                .attr('r', d => d.group === 'lens' ? 20 : 12)
                .attr('fill', d => getColor(d));

            node.append('text')
                .attr('dy', d => d.group === 'lens' ? 35 : 25)
                .attr('text-anchor', 'middle')
                .text(d => d.label.length > 15 ? d.label.substring(0, 15) + '...' : d.label);

            // Simulation tick
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                linkLabel
                    .attr('x', d => (d.source.x + d.target.x) / 2)
                    .attr('y', d => (d.source.y + d.target.y) / 2);

                node.attr('transform', d => `translate(${d.x},${d.y})`);
            });

            function dragstarted(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
            }

            function dragged(event) {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
            }

            function dragended(event) {
                if (!event.active) simulation.alphaTarget(0);
                event.subject.fx = null;
                event.subject.fy = null;
            }
        }
    </script>
</body>
</html>
